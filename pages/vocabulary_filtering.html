<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>词汇净化</title>
    <style>
body {
	font-family: Arial, sans-serif;
	margin: 20px;
}
.word-item {
	margin-bottom: 20px;
}
.clickable-word {
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 4px;
}

.clickable-word.selected {
    background-color: #007bff; /* 选中的背景颜色 */
    color: white;  /* 选中的文本颜色 */
}

.dialog {
    position: fixed;
    top: 20px;
    left: 5px;
    width: 75%; /* 可根据需要调整 */
    max-height: 80vh; /* 最大高度为视口的80% */
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden; /* 隐藏部分溢出内容 */
	overflow-y: auto; /* 启用垂直方向滚动条 */
}

.content {
    max-height: 70vh; /* 内容最大高度 */
    overflow-y: auto; /* 启用垂直方向滚动条 */
    padding: 10px; /* 内容内边距 */
}

.close-btn {
    margin-top: 10px;
}
    </style>
</head>
<body>
    <h2>词汇净化</h2>

<button id="showBaseWords">展示基</button>
<button id="exportJson">导出</button>
<button id="importJson" style="color: red;">导入</button>
<input type="file" id="importJsonFile" accept=".json" /><br>
<label for="startIndex">页码</label>
<input type="number" id="startIndex" value="1" min="1">
<button id="loadJson">跳转</button><br>
<div id="currentPage"></div><br>
<div id="wordList"></div>
<button id="savePage">保存并换到下一页</button>

<script>
const proxy = 'https://missaoempreendedora.com/wp-content/plugins/super-links/application/helpers/super-links-proxy.php?';
let allWords = [];
let categories;
let saveList = [];
let currentPageIndex = 0; // 当前页面索引

// 加载 JSON 数据的事件监听
document.getElementById("loadJson").addEventListener("click", function() {
    // 获取输入的起始页码，并设置 currentPageIndex
    const startIndex = parseInt(document.getElementById("startIndex").value, 10);
    if (startIndex < 1) return; // 如果输入的值小于 1，直接返回
    currentPageIndex = startIndex - 1; // 因为索引是从 0 开始的
	loadWords(); // 加载词汇
});

// 用于生成分类下拉框
function createCategorySelect(word, def, parentValueList = []) {
    let options = [];
    let level = parentValueList.length;

    if (level === 0) {
        options = Object.keys(categories);
    } else if (level === 1 && parentValueList[0] in categories) {
        options = Object.keys(categories[parentValueList[0]]);
    } else if (level === 2 && parentValueList[0] in categories && parentValueList[1] in categories[parentValueList[0]]) {
        options = categories[parentValueList[0]][parentValueList[1]];
    } else {
		return '';
	}

	const selectElement = document.createElement('select');
	selectElement.innerHTML = `<option value="">选择分类</option>`; // 提供选择提示

	options.forEach(optionValue => {
		const optionElement = document.createElement('option');
		optionElement.value = optionValue; 
		optionElement.innerHTML = optionValue;
		selectElement.appendChild(optionElement);
	});

    selectElement.onchange = function() {
        // 清除下级下拉框（如果存在）
        while (selectElement.nextElementSibling) {
			selectElement.parentNode.removeChild(selectElement.nextElementSibling);
		}

        // 创建新的分类列表
        const newParentValueList = [...parentValueList, selectElement.value];

        if (newParentValueList.length < 3) {
			const nextLevelSelect = createCategorySelect(word, def, newParentValueList);
			selectElement.after(nextLevelSelect); // 使用 after 方法添加在当前 select 后
		}
		
		const combinedCategory = newParentValueList.join('-');
		const value = document.querySelector(`input[name="${word}-${def}-category"]`).value;
		if (!value.startsWith(combinedCategory)) {
			document.querySelector(`input[name="${word}-${def}-category"]`).value = combinedCategory;
		}
    };

    return selectElement;
}

function showDefinitionDialog(word) {
    // 在 allWords 中查找对应词的定义
    const wordDataEntry = allWords.find(([w]) => w === word);
    const dialogDiv = document.createElement('div');
    dialogDiv.className = 'dialog'; // 对话框样式
	saveList.push(word);

    dialogDiv.innerHTML = `<h2>${word}</h2><button class="close-btn">关闭</button>`;
    if (wordDataEntry) {
        const meanings = wordDataEntry[1]; // 获取该词的定义
		loadWord(word, dialogDiv);
    } else {
        dialogDiv.innerHTML += `<div>${word} 未收录</div>`;
    }

    document.body.appendChild(dialogDiv);

    // 关闭按钮逻辑
    dialogDiv.querySelector('.close-btn').addEventListener('click', () => {
		save();
		saveList.pop();
        dialogDiv.remove();
    });
}

function loadWord(word, wordListDiv) {
    const wordDataEntry = allWords.find(([w]) => w === word);
    if (!wordDataEntry) return;

    const meanings = wordDataEntry[1];
    const wordItem = document.createElement("div");
    wordItem.className = "word-item";
    wordItem.innerHTML = `<strong>${word}</strong><br>`;

    const storedData = JSON.parse(localStorage.getItem('savedWords')) || {};
    const savedWordData = storedData[word] || {};

    for (const [partOfSpeech, definitions] of Object.entries(meanings)) {
        definitions.forEach(def => {
            const definitionDiv = document.createElement('div');
            const words = def.split(' ').map(w => `<span class="clickable-word">${w}</span>`).join(' ');

            definitionDiv.innerHTML = `
                <strong>${partOfSpeech}:</strong><br>
                - ${words}<br>
                <input type="hidden" name="${word}-${def}-selected" value="" />
                <input type="hidden" name="${word}-${def}-category" value="" />
				<label class="delete-btn"><input type="radio" name="${word}-${def}-options" value="delete" checked />删除</label>
				<label class="base-btn"><input type="radio" name="${word}-${def}-options" value="base" />基</label>
				<label class="category-btn"><input type="radio" name="${word}-${def}-options" value="category" />分类</label>
            `;

            const hiddenInputSelected = definitionDiv.querySelector(`input[name="${word}-${def}-selected"]`);
            const hiddenInputCategory = definitionDiv.querySelector(`input[name="${word}-${def}-category"]`);

			const newSelectElement = createCategorySelect(word, def);
			newSelectElement.id = `${word}-${def}-category`;
			newSelectElement.style.display = 'none';
			definitionDiv.appendChild(newSelectElement);

            // 更新输入框中的值
            if (savedWordData[def]) {
                hiddenInputSelected.value = savedWordData[def] || ''; // 设置已选中的词
                hiddenInputCategory.value = '';
                // 更新UI中的选中状态
                const selectedWords = hiddenInputSelected.value.split(', ');
                selectedWords.forEach(selectedWord => {
                    const clickableWord = Array.from(definitionDiv.querySelectorAll('.clickable-word')).find(el => el.innerText === selectedWord);
                    if (clickableWord) {
                        clickableWord.classList.add('selected'); // 添加选中状态
                    }
                });
				const buttons = definitionDiv.querySelectorAll('.delete-btn, .base-btn, .category-btn');
				if (selectedWords[0] === '') {
					definitionDiv.querySelector(`input[name="${word}-${def}-options"][value="delete"]`).checked = true;
				} else if (selectedWords[0] === '_base') {
					definitionDiv.querySelector(`input[name="${word}-${def}-options"][value="base"]`).checked = true;
				} else if (selectedWords[0].startsWith('_category: ')) {
					definitionDiv.querySelector(`input[name="${word}-${def}-options"][value="category"]`).checked = true;
					hiddenInputCategory.value = selectedWords[0].slice('_category: '.length);
					setTimeout(initCategory, 300);
				} else {
					buttons.forEach(btn => btn.style.display = 'none');
				}
            }
			
			function initCategory(){
				document.getElementById(`${word}-${def}-category`).style.display = 'inline';
				
				const categoryString = hiddenInputCategory.value;
				const categoriesArray = categoryString.split('-').map(item => item.trim());
				let currentSelect = document.getElementById(`${word}-${def}-category`);

				for (let i = 0; i < categoriesArray.length; i++) {
					if (currentSelect && categoriesArray[i]) {
						for (let j = 0; j < currentSelect.options.length; j++) {
							if (currentSelect.options[j].value === categoriesArray[i]) {
								currentSelect.selectedIndex = j; // 选择相应的选项
								currentSelect.onchange();
							}
						}
					}
					currentSelect = currentSelect.nextElementSibling;
				}
			}
			
			function removeCategory(){
				hiddenInputCategory.value = '';
				hiddenInputSelected.value = '';
				const selectedDiv = document.getElementById(`${word}-${def}-category`);
    
				if (selectedDiv) {
					selectedDiv.innerHTML = `<option value="">选择分类</option>`
					Object.keys(categories).forEach(optionValue => {
						const optionElement = document.createElement('option');
						optionElement.value = optionValue; 
						optionElement.innerHTML = optionValue;
						selectedDiv.appendChild(optionElement);
					});
					selectedDiv.onchange();
					selectedDiv.style.display = 'none';
				}
			}

            // 添加单词点击事件
            definitionDiv.querySelectorAll('.clickable-word').forEach(span => {
                span.addEventListener('click', function() {
					removeCategory();
                    this.classList.toggle('selected');
                    const selectedWords = Array.from(definitionDiv.querySelectorAll('.clickable-word.selected')).map(el => el.innerText).join(', ');
                    hiddenInputSelected.value = selectedWords;
					const buttons = definitionDiv.querySelectorAll('.delete-btn, .base-btn, .category-btn');
					if (selectedWords === '') {
						definitionDiv.querySelector(`input[name="${word}-${def}-options"][value="delete"]`).checked = true; // Set the delete radio as checked
						buttons.forEach(btn => btn.style.display = 'inline-block'); 
					} else {
						buttons.forEach(btn => btn.style.display = 'none');
					}
                });
					
				span.addEventListener('dblclick', function() {
					showDefinitionDialog(this.innerText); // Call the dialog
				});
            });

            // 添加按钮的事件
            const deleteBtn = definitionDiv.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', function() {
				removeCategory();
            });

            const baseBtn = definitionDiv.querySelector('.base-btn');
            baseBtn.addEventListener('click', function() {
				removeCategory();
                hiddenInputSelected.value = '_base'; // 设置为 base
            });

            const categoryBtn = definitionDiv.querySelector('.category-btn');
            categoryBtn.addEventListener('click', function() {
                removeCategory();
				document.getElementById(`${word}-${def}-category`).style.display = 'inline';
            });
			
            wordItem.appendChild(definitionDiv);
            wordItem.appendChild(document.createElement('br'));
        });
    }
    wordListDiv.appendChild(wordItem);
}
// 加载多个词
function loadWords() {
	const article = 8;
    const startIndex = currentPageIndex * article;
    const wordListDiv = document.getElementById("wordList");
    const currentPageDiv = document.getElementById("currentPage");
    wordListDiv.innerHTML = ''; // 清空之前的内容
	saveList.length = 0;

    const wordsToDisplay = allWords.slice(startIndex, startIndex + article);
    wordsToDisplay.forEach(([word]) => {
        loadWord(word, wordListDiv);
		saveList.push(word);
    });

    currentPageDiv.innerHTML = `这是第 ${currentPageIndex + 1} 页`;
}

function save(){
    const currentData = JSON.parse(localStorage.getItem('savedWords')) || {};
	const newList = [];

	// 遍历 saveList 中的每个词
	for (const word of saveList) {
		const found = allWords.find(([w]) => w === word);
		if (found) {
			newList.push(found);
		}
	}
    
	for (const [word, meanings] of newList) {
		const wordData = {};
		
		for (const [partOfSpeech, definitions] of Object.entries(meanings)) {
			definitions.forEach(def => {
				const selectedInput = document.querySelector(`input[name="${word}-${def}-selected"]`);
				let selectedWords = selectedInput ? selectedInput.value : '';
				const categoryInput = document.querySelector(`input[name="${word}-${def}-category"]`);
				if (categoryInput.value.length > 0) {
					selectedWords = '_category: ' + categoryInput.value;
				}
				
				if (selectedWords.length > 0) {
					wordData[def] = selectedWords;
				}
			});
		}
		
		currentData[word] = { ...wordData };
	}

    // 保存到 localStorage
    const newStoredData = JSON.parse(localStorage.getItem('savedWords')) || {};
    Object.assign(newStoredData, currentData);
    localStorage.setItem('savedWords', JSON.stringify(newStoredData));
}

function showLoadingMessage() {
    // 创建一个简单的加载消息元素
    const loadingMessage = document.createElement('div');
    loadingMessage.id = 'loading-message';
    loadingMessage.innerText = '正在加载...';
    document.body.appendChild(loadingMessage); // 添加到页面底部
}

function removeLoadingMessage() {
    const loadingMessage = document.getElementById('loading-message');
    if (loadingMessage) {
        document.body.removeChild(loadingMessage); // 移除加载消息
    }
}

window.onload = function() {
	setInterval(save, 20000);
	document.getElementById('importJsonFile').value = '';
	showLoadingMessage();
	// 使用 Promise.all 来并行加载多个 JSON 文件
    Promise.all([
        fetch(proxy + 'https://r-intmax.github.io/pages/dict.json'),
        fetch(proxy + 'https://r-intmax.github.io/pages/classification.json')
    ])
    .then(responses => {
        // 检查每个响应是否成功
        if (!responses[0].ok || !responses[1].ok) {
            throw new Error('网络响应不是 OK');
        }
        return Promise.all(responses.map(response => response.json()));
    })
    .then(data => {
        allWords = Object.entries(data[0]); // 第一个JSON对象
        categories = data[1]; // 第二个JSON对象
    })
	.finally(() => {
		removeLoadingMessage();
	})
};

document.getElementById("savePage").addEventListener("click", function() {
	save();

    // 增加页面索引并加载下一页
    currentPageIndex++;
    loadWords();
	
	// 将页面滚动到顶部
	window.scrollTo({
		top: 0
	});
});

document.getElementById("exportJson").addEventListener("click", function() {
    const savedData = localStorage.getItem('savedWords');
    if (savedData) {
        const parsedData = JSON.parse(savedData);
        
        // 过滤掉值为空的词汇
        const filteredData = Object.fromEntries(
            Object.entries(parsedData).filter(([word, meanings]) => {
                return Object.keys(meanings).length > 0; // 只保留非空对象
            })
        );

        const beautifiedJson = JSON.stringify(filteredData, null, 4);
        const blob = new Blob([beautifiedJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'output.json';
        a.click();
        URL.revokeObjectURL(url); // 释放内存
    } else {
        alert("没有可导出的数据！");
    }
});

document.getElementById("importJson").addEventListener("click", function() {
    const fileInput = document.getElementById("importJsonFile");
    const file = fileInput.files[0];

    if (file) {
        const reader = new FileReader();
        
        reader.onload = function(event) {
            try {
                const data = JSON.parse(event.target.result);
                // 根据你的需求，可以进行进一步的处理，比如过滤无效数据等
                const validData = Object.fromEntries(
                    Object.entries(data).filter(([word, meanings]) => {
                        return Object.keys(meanings).length > 0; // 只保留非空对象
                    })
                );
                
                // 将有效数据存入 localStorage
                localStorage.setItem('savedWords', JSON.stringify(validData));
				alert("导入成功！");
				loadWords();
            } catch (error) {
                alert("无效的 JSON 文件！");
            }
        };

        reader.readAsText(file);
    } else {
        alert("请先选择一个文件！");
    }
});

document.getElementById("showBaseWords").addEventListener("click", function() {
	const savedWords = JSON.parse(localStorage.getItem('savedWords')) || {};
	const baseWords = [];
	
	// 遍历 savedWords
	for (const [w, wordData] of Object.entries(savedWords)) {
		if (wordData && typeof wordData === 'object') {  
			for (const key in wordData) {
				if (wordData.hasOwnProperty(key) && wordData[key].words === '_base') {
					baseWords.push(w); 
					break; 
				}
			}
		}
	}
	
	const wordList = document.createElement('div');
	wordList.innerHTML = '<h2>基词表</h2><button class="close-btn">关闭</button>';
	wordList.className = 'dialog';

	// 将符合条件的单词添加到列表
	baseWords.forEach(word => {
		const li = document.createElement('li');
		li.textContent = word;
		wordList.appendChild(li);
	});
	
	document.body.appendChild(wordList);

	wordList.querySelector('.close-btn').addEventListener('click', () => {
		wordList.remove();
    });
});

    </script>
</body>
</html>
