<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>词汇筛选</title>
    <style>
body {
	font-family: Arial, sans-serif;
	margin: 20px;
}
.word-item {
	margin-bottom: 20px;
}
.clickable-word {
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 4px;
}

.clickable-word.selected {
    background-color: #007bff; /* 选中的背景颜色 */
    color: white;  /* 选中的文本颜色 */
}

.dialog {
    position: fixed;
    top: 50%;
    left: calc(50% + 5px);
    transform: translate(-50%, -50%);
    width: 400px; /* 可根据需要调整 */
    max-height: 80vh; /* 最大高度为视口的80% */
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden; /* 隐藏部分溢出内容 */
	overflow-y: auto; /* 启用垂直方向滚动条 */
}

.content {
    max-height: 70vh; /* 内容最大高度 */
    overflow-y: auto; /* 启用垂直方向滚动条 */
    padding: 10px; /* 内容内边距 */
}

.close-btn {
    margin-top: 10px;
}
    </style>
</head>
<body>
    <h1>词汇筛选</h1>
<label for="startIndex">从第几页开始加载:</label>
<input type="number" id="startIndex" value="1" min="1" max="338">
<button id="loadJson">加载词汇</button><br>
<button id="exportJson">导出</button>
<div id="currentPage"></div><br>
<div id="wordList"></div>
<button id="savePage">保存并换到下一页</button>

<script>
const proxy = 'https://missaoempreendedora.com/wp-content/plugins/super-links/application/helpers/super-links-proxy.php?';
let allWords = [];
let currentPageIndex = 0; // 当前页面索引
let categories;

// 加载 JSON 数据的事件监听
document.getElementById("loadJson").addEventListener("click", function() {
    // 获取输入的起始页码，并设置 currentPageIndex
    const startIndex = parseInt(document.getElementById("startIndex").value, 10);
    if (startIndex < 1) return; // 如果输入的值小于 1，直接返回
    currentPageIndex = startIndex - 1; // 因为索引是从 0 开始的

    // 使用 Promise.all 来并行加载多个 JSON 文件
    Promise.all([
        fetch(proxy + 'https://r-intmax.github.io/pages/dict.json'),
        fetch(proxy + 'https://r-intmax.github.io/pages/classification.json')
    ])
    .then(responses => {
        // 检查每个响应是否成功
        if (!responses[0].ok || !responses[1].ok) {
            throw new Error('网络响应不是 OK');
        }
        return Promise.all(responses.map(response => response.json()));
    })
    .then(data => {
        allWords = Object.entries(data[0]); // 第一个JSON对象
        categories = data[1]; // 第二个JSON对象
        loadWords(); // 加载词汇
    })
    .catch(error => {
        alert('加载 JSON 失败:', error);
    });
});

// 用于生成分类下拉框
function createCategorySelect(word, def, parentValueList = []) {
    let options = [];
    let level = parentValueList.length;

    if (level === 0) {
        options = Object.keys(categories);
    } else if (level === 1) {
        options = Object.keys(categories[parentValueList[0]]);
    } else if (level === 2) {
        options = categories[parentValueList[0]][parentValueList[1]];
    }

	const selectElement = document.createElement('select');
	selectElement.innerHTML = `<option value="">选择分类</option>`; // 提供选择提示

	options.forEach(optionValue => {
		const optionElement = document.createElement('option');
		optionElement.value = optionValue; 
		optionElement.innerHTML = optionValue;
		selectElement.appendChild(optionElement);
	});

    selectElement.onchange = function() {
        // 清除下级下拉框（如果存在）
        while (selectElement.nextSibling) {
            selectElement.parentNode.removeChild(selectElement.nextSibling);
        }

        // 创建新的分类列表
        const newParentValueList = [...parentValueList, selectElement.value];

        if (newParentValueList.length === 3) {
            const categoryInput = document.querySelector(`input[name="${word}-${def}-category"]`);
            const combinedCategory = newParentValueList.join('-');
            if (categoryInput && selectElement.value) {
                categoryInput.value = combinedCategory; // 更新输入框的值
            }
        } else {
			const nextLevelSelect = createCategorySelect(word, def, newParentValueList);
			selectElement.after(nextLevelSelect); // 使用 after 方法添加在当前 select 后
		}
    };

    return selectElement;
}

function showDefinitionDialog(word) {
    // 在 allWords 中查找对应词的定义
    const wordDataEntry = allWords.find(([w]) => w === word);
    const dialogDiv = document.createElement('div');
    dialogDiv.className = 'dialog'; // 对话框样式

    dialogDiv.innerHTML = `<h2>${word}</h2><button class="close-btn">关闭</button>`;
    if (wordDataEntry) {
        const meanings = wordDataEntry[1]; // 获取该词的定义
		loadWord(word, dialogDiv);
    } else {
        dialogDiv.innerHTML += `<div>${word} 未收录</div>`;
    }

    document.body.appendChild(dialogDiv);

    // 关闭按钮逻辑
    dialogDiv.querySelector('.close-btn').addEventListener('click', () => {
        dialogDiv.remove();
        save(); // 关闭时保存
    });
}

function loadWord(word, wordListDiv) {
    const wordDataEntry = allWords.find(([w]) => w === word); // 查找对应的词汇定义
    if (!wordDataEntry) return; // 若未找到对应的词，则返回

    const meanings = wordDataEntry[1]; // 获取该词的定义
    const wordItem = document.createElement("div");
    wordItem.className = "word-item";
    wordItem.innerHTML = `<strong>${word}</strong><br>`;

    // 获取已保存的单词数据
    const storedData = JSON.parse(localStorage.getItem('savedWords')) || {};
    const savedWordData = storedData[word] || {};

    for (const [partOfSpeech, definitions] of Object.entries(meanings)) {
        definitions.forEach(def => {
            const definitionDiv = document.createElement('div');
            const words = def.split(' ').map(w => `<span class="clickable-word">${w}</span>`).join(' ');

            definitionDiv.innerHTML = `
                <strong>${partOfSpeech}:</strong><br>
                - ${words}<br>
                <input type="hidden" name="${word}-${def}-selected" value="" /> <!-- 存储选择的词 -->
                <input type="hidden" name="${word}-${def}-category" value="" /> <!-- 存储分类(若有) -->
            `;

            // 设置隐藏输入的值，如果存在的话
            const hiddenInputSelected = definitionDiv.querySelector(`input[name="${word}-${def}-selected"]`);
            const hiddenInputCategory = definitionDiv.querySelector(`input[name="${word}-${def}-category"]`);
            
            if (savedWordData[def]) {
                hiddenInputSelected.value = savedWordData[def].words.join(', ') || ''; // 设置已选中的词
                hiddenInputCategory.value = savedWordData[def].category || ''; // 设置分类
                // 更新UI中的选中状态
                const selectedWords = hiddenInputSelected.value.split(', ');
                selectedWords.forEach(selectedWord => {
                    const clickableWord = Array.from(definitionDiv.querySelectorAll('.clickable-word')).find(el => el.innerText === selectedWord);
                    if (clickableWord) {
                        clickableWord.classList.add('selected'); // 添加选中状态
                    }
                });
            }

            // 为每个单词添加点击和长按事件
            definitionDiv.querySelectorAll('.clickable-word').forEach(span => {
                span.addEventListener('click', function() {
                    this.classList.toggle('selected'); // 切换选中状态
                    const hiddenInput = definitionDiv.querySelector(`input[name="${word}-${def}-selected"]`);
                    const selectedWords = Array.from(definitionDiv.querySelectorAll('.clickable-word.selected')).map(el => el.innerText).join(', ');
                    hiddenInput.value = selectedWords; // 记录选择的单词
                });

                span.addEventListener('dblclick', function() {
                    showDefinitionDialog(this.innerText); // Call the dialog
                });
            });

            const newSelectElement = createCategorySelect(word, def);
            definitionDiv.appendChild(newSelectElement);
            wordItem.appendChild(definitionDiv);
            wordItem.appendChild(document.createElement('br'));
        });
    }
    wordListDiv.appendChild(wordItem);
}

// 加载多个词
function loadWords() {
    const startIndex = currentPageIndex * 10; // 每页显示 10 个词
    const wordListDiv = document.getElementById("wordList");
    const currentPageDiv = document.getElementById("currentPage");
    wordListDiv.innerHTML = ''; // 清空之前的内容

    const wordsToDisplay = allWords.slice(startIndex, startIndex + 10);
    wordsToDisplay.forEach(([word]) => {
        loadWord(word, wordListDiv);
    });

    currentPageDiv.innerHTML = `这是第 ${currentPageIndex + 1} 页`;
}

function save(){
    const currentData = {};
    
	for (const [word, meanings] of allWords) {
		const wordData = {};
		
		for (const [partOfSpeech, definitions] of Object.entries(meanings)) {
			definitions.forEach(def => {
				// 从定义中获取已被选中的单词
				const selectedWords = Array.from(document.querySelectorAll(`div[name="${word}-${def}-selected"] .clickable-word.selected`))
					.map(el => el.innerText);

				// 安全获取分类值，若未输入，则置为默认值
				const categoryInput = document.querySelector(`input[name="${word}-${def}-category"]`);
				const category = categoryInput ? categoryInput.value : '';

				// 如果用户选择了任何单词，则将它们存储在 wordData 中
				if (selectedWords.length > 0) {
					wordData[def] = {
						words: selectedWords,
						category: category
					};
				} else {
					// wordData[def] = null;
				}
			});
		}
		
		currentData[word] = { ...wordData };
	}

    // 保存到 localStorage
    const storedData = JSON.parse(localStorage.getItem('savedWords')) || {};
    Object.assign(storedData, currentData);
    localStorage.setItem('savedWords', JSON.stringify(storedData));
}

document.getElementById("savePage").addEventListener("click", function() {
	save();

    // 增加页面索引并加载下一页
    currentPageIndex++;
    loadWords();
	
	// 将页面滚动到顶部
	window.scrollTo({
		top: 0,
		behavior: 'smooth' // 动画的滚动效果
	});
});

document.getElementById("exportJson").addEventListener("click", function() {
    const savedData = localStorage.getItem('savedWords');
    if (savedData) {
        const parsedData = JSON.parse(savedData);
        
        // 过滤掉值为空的词汇
        const filteredData = Object.fromEntries(
            Object.entries(parsedData).filter(([word, meanings]) => {
                return Object.keys(meanings).length > 0; // 只保留非空对象
            })
        );

        // 格式化为美化的 JSON 字符串
        const beautifiedJson = JSON.stringify(filteredData, null, 4);
        
        const blob = new Blob([beautifiedJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'output.json';
        a.click();
        URL.revokeObjectURL(url); // 释放内存
    } else {
        alert("没有可导出的数据！");
    }
});
    </script>
</body>
</html>
